## M8: Прикручивание QueryCost (DoS)

-----

### Что такое QueryCost?

-----

### QueryCost считает сложность запроса, который необходимо выполнить серверу. <!-- .element: class="orange" -->

<br/>

Считает в попугаях. Ну или чтоб проще было понять – максимально возможно кол-во полей. <!-- .element: class="fragment" -->

-----

### Считает исходя из <!-- .element: class="orange" -->

- полученного запроса от клиента <!-- .element: class="fragment" -->
- переданных переменных с запросом <!-- .element: class="fragment" -->
- и простой логикой перемножения аргументов на вес полей или вес детей <!-- .element: class="fragment" -->

-----

### Операция выполняется после парсинга запроса, НО до вызова резолверов.

-----

### Если сложность запроса больше какого-то числа

- возвращаем ошибку клиенту
- запрос не выполняем (не запускаем `execute`)

-----

### Прикручиваем к `wrike-graphql`

- Берем пакет [`graphql-query-complexity`](https://github.com/slicknode/graphql-query-complexity)
- Создали плагин к аполло-серверу [`queryCostPlugin.ts`](https://github.com/nodkz/wrike-graphql/blob/master/src/queryCostPlugin.ts)
- И создаем функции `complexity` по нашей схеме (Complexity Estimators)

-----

### Добавляем функции `complexity`

- ко всем точкам входа в наш граф M4 (полям Query)
- по желанию можно добавить к мутациям.
- к релейшенам M7, которые возвращают списки
  
-----

### Находим "проблемы" в REST API Wrike

- плохо, что не везде есть лимиты на кол-во возвращаемых элементов

(например в `Folders` нет лимита на кол-во возвращаемых данных. И чер его знает сколько там может вернуться записей, поэтому тяжело спрогнозировать сложность вложенного запроса

-----

### Как workaround

- если нет аргументов `limit` или `pageSize`
- то ставим `extensions: { complexity: ({ childComplexity }) => childComplexity * 10 }`

Cчитаем, что в списках в среднем возвращается 10 элементов.

-----

### Смотрим

- `queryCostPlugin.ts`
- `schema/entrypoints/query/taskFindMany.ts`
- `schema/relations/task.ts`

-----

### Грубая оценка M8

- написали 1 плагин
- добавил 55 complexity функций
- накостылили 29 workaround'ов (где нет лимитов)
- ~ `⏱ 10 часов`
